(()=>{"use strict";(()=>{const e=(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e);window.util={getRandomInRange:e,getRandomArray:e=>e.slice(0,Math.floor(Math.random()*e.length)),getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],getLocation:(t,o)=>e(t,o),getPrice:e=>Math.round(Math.random()*e),toggleAdFormElements:(e,t)=>{for(let o=0;o<e.length;o++)e[o].disabled=!t},debounce:e=>{let t=null;return o=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),300)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o)=>{e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}.`)})),e.addEventListener("error",(function(){o("Произошла ошибка соединения.")})),e.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${e.timeout} мс.`)})),e.timeout=1e4};window.backend={download:(o,n)=>{const r=new XMLHttpRequest;r.responseType="json",t(r,o,n),r.open("GET",e+"/data"),r.send()},upload:(o,n,r)=>{const a=new XMLHttpRequest;a.responseType="json",t(a,n,r),a.open("POST",e),a.send(o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__input"),r=document.querySelector(".ad-form__photo");let a=!1;const s=(t,o)=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){a=!0;const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result,o.style="height: auto"})),e.readAsDataURL(n)}};t.addEventListener("change",(()=>{s(t,o)})),n.addEventListener("change",(()=>{const e=(()=>{r.style="display: flex; justify-content: center; align-items: center;";const e=document.createElement("img");r.appendChild(e);const t=r.querySelector("img");return t.classList.add("visually-hidden"),t.width=60,t.src="#",t})();s(n,e),a&&e.classList.remove("visually-hidden")})),window.photos={resetAvatar:()=>{o.src="img/muffin-grey.svg"},resetImagePreview:()=>{const e=r.querySelector("img");r.contains(e)&&r.removeChild(e)}}})(),(()=>{const e=1e6,t=document.querySelectorAll("select"),o=document.querySelectorAll("input"),n=document.querySelector("textarea"),r=document.querySelector(".map").querySelector(".map__pin--main"),a=document.querySelector(".ad-form"),s=a.querySelector("#address"),d=a.querySelector("#title"),c=a.querySelector("#type"),l=a.querySelector("#price"),i=a.querySelector("#timein"),u=a.querySelector("#timeout"),m=a.querySelector("#room_number"),p=a.querySelector("#capacity"),y={bungalow:0,flat:1e3,house:5e3,palace:1e4};let v=!1;const w=(e,t)=>{const o=Math.round(e+32.5),n=Math.round(v?t+32.5+22:t+32.5);s.value=`${o}, ${n}`},f=()=>{l.placeholder=y[c.value],l.min=y[c.value],l.max=e},h=e=>{u.value=e.target.value,i.value=e.target.value},g=()=>{100==+m.value&&0!=+p.value?m.setCustomValidity("Не для гостей"):100!=+m.value&&0==+p.value||0!=+p.value&&+m.value<+p.value?m.setCustomValidity("Слишком мало места"):m.setCustomValidity(""),m.reportValidity()};c.addEventListener("change",f),d.addEventListener("change",(e=>{0===e.target.value.length?d.setCustomValidity("Введите заголовок!"):e.target.value.length<30?d.setCustomValidity("Не менее 30 символов!"):e.target.value.length>100?d.setCustomValidity("Не более 100 символов!"):d.setCustomValidity("")})),l.addEventListener("change",(()=>{l.min=y[c.value],l.max=e,l.value<+l.min||l.value>+l.max?l.setCustomValidity(`От ${l.min} до ${l.max}`):l.setCustomValidity("")})),i.addEventListener("change",h),u.addEventListener("change",h),m.addEventListener("change",g),p.addEventListener("change",g),a.addEventListener("submit",g),window.form={isPageActive:v,calcAdAddress:w,enableForm:()=>{v=!0,a.classList.remove("ad-form--disabled"),w(parseInt(r.style.left,10),parseInt(r.style.top,10)),window.util.toggleAdFormElements(t,v),window.util.toggleAdFormElements(o,v),n.disabled=!v},disableForm:()=>{v=!1,a.classList.add("ad-form--disabled"),w(parseInt(r.style.left,10),parseInt(r.style.top,10)),window.util.toggleAdFormElements(t,v),window.util.toggleAdFormElements(o,v),n.disabled=!v},onTypeInput:f,onRoomsInput:g}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success");window.messages={showErrorMessage:o=>{e.appendChild(t.cloneNode(!0)),document.querySelector(".error__message").textContent=o;const n=document.querySelector(".error"),r=()=>{e.removeChild(n),document.removeEventListener("keydown",a)},a=t=>{"Escape"===t.key&&e.contains(n)&&r()};n.addEventListener("click",(()=>{e.contains(n)&&r()})),document.addEventListener("keydown",a)},showSuccessMessage:()=>{e.appendChild(o.cloneNode(!0));const t=document.querySelector(".success"),n=()=>{e.removeChild(t),document.removeEventListener("keydown",r)},r=o=>{"Escape"===o.key&&e.contains(t)&&n()};t.addEventListener("click",(()=>{e.contains(t)&&n()})),document.addEventListener("keydown",r)}}})(),(()=>{const e=Math.floor(75.5),t=Math.floor(575.5),o=Math.floor(-32.5),n=Math.floor(1167.5);window.dragAndDrop={moveElement:(r,a)=>{r.addEventListener("mousedown",(r=>{r.preventDefault();let s={x:r.clientX,y:r.clientY};const d=function(r){r.preventDefault();let d=s.x-r.clientX,c=s.y-r.clientY;s={x:r.clientX,y:r.clientY},parseInt(a.style.top,10)>t?a.style.top=t+"px":parseInt(a.style.top,10)<e?a.style.top=e+"px":a.style.top=a.offsetTop-c+"px",parseInt(a.style.left,10)>n?a.style.left=n+"px":parseInt(a.style.left,10)<o?a.style.left=o+"px":a.style.left=a.offsetLeft-d+"px",window.form.calcAdAddress(parseInt(a.style.left,10),parseInt(a.style.top,10))},c=function(e){e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)}))}}})(),(()=>{const e="any",t=document.querySelector(".map").querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),s=t=>{switch(n.value){case e:return!0;case"low":return t.offer.price<1e4;case"middle":return t.offer.price<=5e4&&t.offer.price>=1e4;case"high":return t.offer.price>5e4}return!1},d=t=>+r.value===t.offer.rooms||r.value===e,c=t=>a.value<=t.offer.guests||a.value===e,l=e=>{const o=t.querySelectorAll(".map__checkbox:checked");return Array.from(o).every((t=>e.offer.features.includes(t.value)))},i=t=>{const n=[];for(let a=0;a<t.length&&n.length<5;a++)r=t[a],(o.value===r.offer.type||o.value===e)&&s(t[a])&&d(t[a])&&c(t[a])&&l(t[a])&&n.push(t[a]);var r;return n};t.addEventListener("change",window.util.debounce((()=>{const e=i(window.data);window.pin.render(e)}))),window.filter={getOffers:i}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};let n=null;const r=()=>{n&&(e.removeChild(n),n=null,document.removeEventListener("keydown",a),window.pin.dropActiveClass())},a=e=>{"Escape"===e.key&&r()};window.card={create:e=>{const{author:s,offer:d}=e,{avatar:c}=s,{title:l,address:i,price:u,type:m,rooms:p,guests:y,checkin:v,checkout:w,features:f,description:h,photos:g}=d,_=t.cloneNode(!0),S=_.querySelector(".popup__avatar"),q=_.querySelector(".popup__title"),E=_.querySelector(".popup__text--address"),L=_.querySelector(".popup__text--price"),x=_.querySelector(".popup__type"),C=_.querySelector(".popup__text--capacity"),k=_.querySelector(".popup__text--time"),A=_.querySelector(".popup__description"),M=_.querySelector(".popup__features"),b=_.querySelector(".popup__photos"),I=_.querySelector(".popup__photo"),$=_.querySelector(".popup__close");if(S.src=c,q.textContent=l,E.textContent=i,L.textContent=u+"₽/ночь",x.textContent=o[m],C.textContent=`${p} комнаты для ${y} гостей`,k.textContent=`Заезд после ${v}, выезд до ${w}`,A.textContent=h,M.innerHTML="",b.innerHTML="",f.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),M.append(t)})),g.forEach((e=>{const t=I.cloneNode();t.src=""+e,b.append(t)})),$.addEventListener("click",r),document.addEventListener("keydown",a),n=_,_.hasChildNodes()){const e=_.childNodes;Array.from(e).forEach((e=>{""!==e.textContent||"IMG"===e.tagName||e.hasChildNodes()||_.removeChild(e)}))}return _},remove:r}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),n=document.querySelector("#pin").content.querySelector(".map__pin"),r=()=>{t.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")}))},a=t=>{const a=n.cloneNode(!0),s=a.querySelector("img");s.src=t.author.avatar,s.alt=t.offer.title,a.style=`left: ${t.location.x}px; top: ${t.location.y}px;`;const d=()=>(window.card.remove(),window.card.create(t));return a.addEventListener("click",(()=>{e.insertBefore(d(),o),r(),a.classList.add("map__pin--active")})),a.addEventListener("keydown",(t=>{"Enter"===t.key&&(e.insertBefore(d(),o),r(),a.classList.add("map__pin--active"))})),a},s=()=>{const e=document.querySelectorAll(".map__pin");document.querySelector(".map__pin--main").style="left: 570px; top: 375px;";for(let o=1;o<e.length;o++)t.removeChild(e[o])};window.pin={dropActiveClass:r,create:a,render:e=>{window.card.remove(),s();const o=document.createDocumentFragment();e.forEach((e=>o.appendChild(a(e)))),t.appendChild(o)},remove:s}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),n=document.querySelector(".ad-form__reset"),r=document.querySelector(".map__filters"),a=e.querySelector(".map__filters");let s=null;const d=e=>{window.data=e;const t=window.filter.getOffers(e);window.pin.render(t,s)},c=e=>{m(),window.messages.showErrorMessage(e)},l=()=>{i(),window.messages.showSuccessMessage()},i=()=>{o.reset(),a.reset(),window.photos.resetAvatar(),window.photos.resetImagePreview(),window.form.onTypeInput(),window.form.onRoomsInput(),m()},u=()=>{window.form.isPageActive=!0,e.classList.remove("map--faded"),window.backend.download(d,c),window.form.enableForm()},m=()=>{window.form.isPageActive=!1,e.classList.add("map--faded"),window.pin.remove(),window.card.remove(),window.form.disableForm()};t.addEventListener("mousedown",(e=>{0===e.button&&!0!==window.form.isPageActive&&u()})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&!0!==window.form.isPageActive&&u()})),o.addEventListener("submit",(e=>{e.preventDefault(),o.checkValidity()&&window.backend.upload(new FormData(o),l,c)})),n.addEventListener("click",(e=>{e.preventDefault(),i()})),n.addEventListener("keydown",(e=>{e.preventDefault(),"Enter"===e.key&&i(e)})),r.addEventListener("click",(e=>{s=e.target})),i(),window.dragAndDrop.moveElement(t,t)})()})();