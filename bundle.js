(()=>{"use strict";(()=>{const e=(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e);window.util={getRandomInRange:e,getRandomArray:e=>e.slice(0,Math.floor(Math.random()*e.length)),getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],getLocation:(t,o)=>e(t,o),getPrice:e=>Math.round(Math.random()*e),toggleAdFormElements:(e,t)=>{for(let o=0;o<e.length;o++)e[o].disabled=!t},debounce:e=>{let t=null;return o=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),300)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o)=>{e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}.`)})),e.addEventListener("error",(function(){o("Произошла ошибка соединения.")})),e.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${e.timeout} мс.`)})),e.timeout=1e4};window.backend={download:(o,r)=>{const n=new XMLHttpRequest;n.responseType="json",t(n,o,r),n.open("GET",e+"/data"),n.send()},upload:(o,r,n)=>{const a=new XMLHttpRequest;a.responseType="json",t(a,r,n),a.open("POST",e),a.send(o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__input"),n=document.querySelector(".ad-form__photo");let a=!1;const s=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){a=!0;const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result,o.style="height: auto"})),e.readAsDataURL(r)}};t.addEventListener("change",(()=>{s(t,o)})),r.addEventListener("change",(()=>{const e=(()=>{n.style="display: flex; justify-content: center; align-items: center;";const e=document.createElement("img");n.appendChild(e);const t=n.querySelector("img");return t.classList.add("visually-hidden"),t.width=60,t.src="#",t})();s(r,e),a&&e.classList.remove("visually-hidden")})),window.photos={resetAvatar:()=>{o.src="img/muffin-grey.svg"},resetImagePreview:()=>{const e=n.querySelector("img");n.contains(e)&&n.removeChild(e)}}})(),(()=>{const e=document.querySelectorAll("select"),t=document.querySelectorAll("input"),o=document.querySelector("textarea"),r=document.querySelector(".map").querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),a=n.querySelector("#address"),s=n.querySelector("#title"),d=n.querySelector("#type"),l=n.querySelector("#price"),c=n.querySelector("#timein"),i=n.querySelector("#timeout"),u=n.querySelector("#room_number"),m=n.querySelector("#capacity"),p={bungalow:0,flat:1e3,house:5e3,palace:1e4};let y=!1;const v=(e,t)=>{const o=Math.round(e+32.5),r=Math.round(y?t+32.5+22:t+32.5);a.value=`${o}, ${r}`},w=e=>{i.value=e.target.value,c.value=e.target.value},f=()=>{100==+u.value&&0!=+m.value?u.setCustomValidity("Не для гостей"):100!=+u.value&&0==+m.value||0!=+m.value&&+u.value<+m.value?u.setCustomValidity("Слишком мало места"):u.setCustomValidity(""),u.reportValidity()};s.addEventListener("change",(e=>{0===e.target.value.length?s.setCustomValidity("Введите заголовок!"):e.target.value.length<30?s.setCustomValidity("Не менее 30 символов!"):e.target.value.length>100?s.setCustomValidity("Не более 100 символов!"):s.setCustomValidity("")})),l.addEventListener("change",(()=>{l.min=p[d.value],l.max=1e6,l.placeholder=p[d.value],l.value<+l.min||l.value>+l.max?l.setCustomValidity(`От ${l.min} до ${l.max}`):l.setCustomValidity("")})),c.addEventListener("change",w),i.addEventListener("change",w),u.addEventListener("change",f),m.addEventListener("change",f),n.addEventListener("submit",f),window.form={isPageActive:y,calcAdAddress:v,enableForm:()=>{y=!0,n.classList.remove("ad-form--disabled"),v(parseInt(r.style.left,10),parseInt(r.style.top,10)),window.util.toggleAdFormElements(e,y),window.util.toggleAdFormElements(t,y),o.disabled=!y},disableForm:()=>{y=!1,n.classList.add("ad-form--disabled"),v(parseInt(r.style.left,10),parseInt(r.style.top,10)),window.util.toggleAdFormElements(e,y),window.util.toggleAdFormElements(t,y),o.disabled=!y},onRoomsInput:f}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success");window.messages={showErrorMessage:o=>{e.appendChild(t.cloneNode(!0)),document.querySelector(".error__message").textContent=o;const r=document.querySelector(".error"),n=()=>{e.removeChild(r),document.removeEventListener("keydown",a)},a=t=>{"Escape"===t.key&&e.contains(r)&&n()};r.addEventListener("click",(()=>{e.contains(r)&&n()})),document.addEventListener("keydown",a)},showSuccessMessage:()=>{e.appendChild(o.cloneNode(!0));const t=document.querySelector(".success"),r=()=>{e.removeChild(t),document.removeEventListener("keydown",n)},n=o=>{"Escape"===o.key&&e.contains(t)&&r()};t.addEventListener("click",(()=>{e.contains(t)&&r()})),document.addEventListener("keydown",n)}}})(),(()=>{const e=Math.floor(75.5),t=Math.floor(575.5),o=Math.floor(-32.5),r=Math.floor(1167.5);window.dragAndDrop={moveElement:(n,a)=>{n.addEventListener("mousedown",(n=>{n.preventDefault();let s={x:n.clientX,y:n.clientY};const d=function(n){n.preventDefault();let d=s.x-n.clientX,l=s.y-n.clientY;s={x:n.clientX,y:n.clientY},parseInt(a.style.top,10)>t?a.style.top=t+"px":parseInt(a.style.top,10)<e?a.style.top=e+"px":a.style.top=a.offsetTop-l+"px",parseInt(a.style.left,10)>r?a.style.left=r+"px":parseInt(a.style.left,10)<o?a.style.left=o+"px":a.style.left=a.offsetLeft-d+"px",window.form.calcAdAddress(parseInt(a.style.left,10),parseInt(a.style.top,10))},l=function(e){e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",l)}))}}})(),(()=>{const e="any",t=document.querySelector(".map").querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),s=t=>{switch(r.value){case e:return!0;case"low":return t.offer.price<1e4;case"middle":return t.offer.price<=5e4&&t.offer.price>=1e4;case"high":return t.offer.price>5e4}return!1},d=t=>+n.value===t.offer.rooms||n.value===e,l=t=>a.value<=t.offer.guests||a.value===e,c=e=>{const o=t.querySelectorAll(".map__checkbox:checked");return Array.from(o).every((t=>e.offer.features.includes(t.value)))},i=t=>{const r=[];let n=0;for(let i=0;i<t.length&&(n++,a=t[i],(o.value===a.offer.type||o.value===e)&&s(t[i])&&d(t[i])&&l(t[i])&&c(t[i])&&r.push(t[i]),5!==n);i++);var a;return r};t.addEventListener("change",window.util.debounce((()=>{const e=i(window.data);window.pin.render(e)}))),window.filter={getOffers:i}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};let r=null;const n=()=>{r&&(e.removeChild(r),r=null,document.removeEventListener("keydown",a),window.pin.dropActiveClass())},a=e=>{"Escape"===e.key&&n()};window.card={create:e=>{const{author:s,offer:d}=e,{avatar:l}=s,{title:c,address:i,price:u,type:m,rooms:p,guests:y,checkin:v,checkout:w,features:f,description:h,photos:g}=d,_=t.cloneNode(!0),S=_.querySelector(".popup__avatar"),q=_.querySelector(".popup__title"),E=_.querySelector(".popup__text--address"),L=_.querySelector(".popup__text--price"),x=_.querySelector(".popup__type"),C=_.querySelector(".popup__text--capacity"),k=_.querySelector(".popup__text--time"),A=_.querySelector(".popup__description"),M=_.querySelector(".popup__features"),b=_.querySelector(".popup__photos"),I=_.querySelector(".popup__photo"),$=_.querySelector(".popup__close");S.src=l,q.textContent=c,E.textContent=i,L.textContent=u+"₽/ночь",x.textContent=o[m],C.textContent=`${p} комнаты для ${y} гостей`,k.textContent=`Заезд после ${v}, выезд до ${w}`,A.textContent=h,M.innerHTML="",b.innerHTML="";for(let e=0;e<f.length;e++){const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+f[e]),M.append(t)}for(let e=0;e<g.length;e++){const t=I.cloneNode();t.src=""+g[e],b.append(t)}if($.addEventListener("click",n),document.addEventListener("keydown",a),r=_,_.hasChildNodes()){const e=_.childNodes;Array.from(e).forEach((e=>{""!==e.textContent||"IMG"===e.tagName||e.hasChildNodes()||_.removeChild(e)}))}return _},remove:n}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),r=document.querySelector("#pin").content.querySelector(".map__pin"),n=()=>{t.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")}))},a=t=>{const a=r.cloneNode(!0),s=a.querySelector("img");s.src=t.author.avatar,s.alt=t.offer.title,a.style=`left: ${t.location.x}px; top: ${t.location.y}px;`;const d=()=>(window.card.remove(),window.card.create(t));return a.addEventListener("click",(()=>{e.insertBefore(d(),o),n(),a.classList.add("map__pin--active")})),a.addEventListener("keydown",(t=>{"Enter"===t.key&&(e.insertBefore(d(),o),n(),a.classList.add("map__pin--active"))})),a},s=()=>{const e=document.querySelectorAll(".map__pin");document.querySelector(".map__pin--main").style="left: 570px; top: 375px;";for(let o=1;o<e.length;o++)t.removeChild(e[o])};window.pin={dropActiveClass:n,create:a,render:e=>{window.card.remove(),s();const o=document.createDocumentFragment();e.forEach((e=>o.appendChild(a(e)))),t.appendChild(o)},remove:s}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelector(".ad-form__reset"),n=document.querySelector(".map__filters"),a=e.querySelector(".map__filters");let s=null;const d=e=>{window.data=e;const t=window.filter.getOffers(e);window.pin.render(t,s)},l=e=>{m(),window.messages.showErrorMessage(e)},c=()=>{i(),window.messages.showSuccessMessage()},i=()=>{o.reset(),a.reset(),window.photos.resetAvatar(),window.photos.resetImagePreview(),m()},u=()=>{window.form.isPageActive=!0,e.classList.remove("map--faded"),window.backend.download(d,l),window.form.enableForm()},m=()=>{window.form.isPageActive=!1,e.classList.add("map--faded"),window.pin.remove(),window.card.remove(),window.form.disableForm()};t.addEventListener("mousedown",(e=>{0===e.button&&!0!==window.form.isPageActive&&u()})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&!0!==window.form.isPageActive&&u()})),o.addEventListener("submit",(e=>{e.preventDefault(),o.checkValidity()&&window.backend.upload(new FormData(o),c,l)})),r.addEventListener("click",(e=>{e.preventDefault(),i()})),r.addEventListener("keydown",(e=>{e.preventDefault(),"Enter"===e.key&&i(e)})),n.addEventListener("click",(e=>{s=e.target})),m(),window.dragAndDrop.moveElement(t,t)})()})();